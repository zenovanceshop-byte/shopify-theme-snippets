{% liquid 
  # KS Coundown Sale
  # © 2025 KondaSoft
  # https://www.kondasoft.com
%}

{% liquid 
  assign show_block = false
  assign countdown_block = section.blocks | where: 'type', 'countdown' | first
  assign text_block = section.blocks | where: 'type', 'text' | first

  assign datetime = countdown_block.settings.datetime
  assign unixtime = datetime | date: '%s'
  assign now = 'now' | date: '%s'

  if unixtime > now
    assign show_block = true
  endif

  if shop.permanent_domain contains 'ks-'
    assign show_block = true
  endif
%}

{%- stylesheet -%}
  .ks-countdown-sale {
    --color-button: var(--color-foreground);
    --color-button-text: var(--color-background);
    --color-secondary-button: var(--color-background);
    --color-secondary-button-text: var(--color-foreground);
    background-color: rgba(var(--color-background), 1);
    color: rgba(var(--color-foreground), 1);
    position: relative;
    overflow: hidden;
  }

  .ks-countdown-sale .ks-media-wrapper {
    --opacity: 0;
    position: absolute;
    width: 100%;
    top: 50%;
    transform: translateY(-50%);
  }

  .ks-countdown-sale .ks-media-wrapper::after {
    content: "";
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    background-color: rgba(var(--overlay-color-rgb), var(--overlay-opacity, 0.7));
    backdrop-filter: blur(var(--overlay-blur, 0));
  }

  .ks-countdown-sale .ks-media-wrapper img { 
      width: 100%;
      object-fit: cover;
  }

  .ks-countdown-sale-inner {
  }

  .ks-countdown-sale-countdown {
    text-align: center;
  }
  
  .ks-countdown-sale-text {
  }

  .ks-countdown-sale-text .title {
    margin-top: 0;
    margin-bottom: 12px;
    color: currentColor;
  }

  .ks-countdown-sale-text .description {
    margin-top: 0;
    margin-bottom: 30px;
  }

  .ks-countdown-sale-text .btn-wrapper {
    display: inline-flex;
    /* flex-wrap: wrap; */
    gap: 10px;
    word-break: break-word;
  }

  .ks-countdown-sale-text .button--primary {
    --alpha-button-background: 1;
  }

  .ks-countdown-sale-text .button--secondary {
    --alpha-button-background: 0;
  }

  .ks-countdown {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    opacity: 1;
    transition: all .2s ease-out;
  }

  .ks-countdown[data-init] {
    opacity: 1;
  }

  .ks-countdown span {
    border-width: 2px;
    border-style: solid;
    border-color: var(--bs-border-color);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    border-radius: 50rem;
    line-height: 1;
  }

  .ks-countdown span em {
    display: block;
    margin-bottom: .5rem;
    opacity: 1;
    font-style: normal;
  }

  .ks-countdown[data-animation="true"] span {
    animation: ks_countdown_item 1s linear infinite alternate;
  }

  .ks-countdown[data-animation="true"] span:nth-child(2) { animation-delay: .5s; }
  .ks-countdown[data-animation="true"] span:nth-child(3) { animation-delay: 1s; }
  .ks-countdown[data-animation="true"] span:nth-child(4) { animation-delay: 1.5s; }


  @keyframes ks_countdown_item {
    from { transform:  translateY(-.25rem) }
    to { transform:  translateY(.25rem) }
  }

  @media (max-width: 749px) {
    .ks-countdown-sale .ks-media-media-mobile {
      display: block;
    }
    .ks-countdown-sale .ks-media-media-desktop {
      display: none;
    }
    .ks-countdown-sale-inner {
      display: flex;
      flex-direction: column;
    }
    .ks-countdown-sale-inner[data-align-mobile="column-reverse"] {
      flex-direction: column-reverse;
    }
    .ks-countdown-sale-countdown {
      padding: 1rem 0 0;
    }
    .ks-countdown-sale-text {
      text-align: center;
      padding: 2rem;
    }
    .ks-countdown span {
      margin: 4px;
    }
    .ks-countdown span em {
      font-size: 12px;
    }
  }

  @media (min-width: 750px) {
    .ks-countdown-sale .ks-media-media-mobile {
      display: none;
    }
    .ks-countdown-sale .ks-media-media-desktop {
      display: block;
    }
    .ks-countdown-sale-inner {
      display: flex;
      align-items: center;
    }
    .ks-countdown-sale-countdown[data-has-text="false"] {
      width: 100%;
    }
    .ks-countdown-sale-countdown[data-has-text="true"] {
      width: 50%;
    }
    .ks-countdown-sale-text {
      width: 50%;
      padding: 64px;
    }
    .ks-countdown span {
      margin: 8px;
    }
    .ks-countdown span em {
      font-size: 15px;
    }
  }

{%- endstylesheet -%}

{%- style -%}
  #ks-countdown-sale-{{ section.id }} {
      --color-background: {{ section.settings.background_color | color_to_rgb | remove: 'rgb(' | remove: ')' }};
      --color-foreground: {{ section.settings.foreground_color | color_to_rgb | remove: 'rgb(' | remove: ')' }};
    }

    #ks-countdown-sale-{{ section.id }} .ks-countdown > span {
      background-color: {{ countdown_block.settings.bg_color }};
      color: {{ countdown_block.settings.text_color }};
      border-width: {{ countdown_block.settings.border_width }}px;
      border-color: {{ countdown_block.settings.border_color }};
    }

    @media (max-width: 749px) {
      #ks-countdown-sale-{{ section.id }} {
        padding-top: {{ section.settings.pt | times: 0.75 | round: 0 }}px;
        padding-bottom: {{ section.settings.pb | times: 0.75 | round: 0 }}px; 
      }
      #ks-countdown-sale-{{ section.id }} .ks-countdown span {
        width: {{ countdown_block.settings.font_size_mobile | times: 1.75 | append: 'px' }};
        height: {{ countdown_block.settings.font_size_mobile | times: 1.75 | append: 'px' }};
        font-size: {{ countdown_block.settings.font_size_mobile | append: 'px' }};
      }
    }

    @media (min-width: 750px) {
      #ks-countdown-sale-{{ section.id }} {
        padding-top: {{ section.settings.pt }}px;
        padding-bottom: {{ section.settings.pb }}px;
      }
      #ks-countdown-sale-{{ section.id }} .ks-countdown span {
        width: {{ countdown_block.settings.font_size_desktop | times: 1.75 | append: 'px' }};
        height: {{ countdown_block.settings.font_size_desktop | times: 1.75 | append: 'px' }};
        font-size: {{ countdown_block.settings.font_size_desktop | append: 'px' }};
      }
    }
{%- endstyle -%}

{%- javascript -%}
  class KsCountdown extends HTMLElement {
    constructor () {
      super()

      if (!this.dataset.time.length) {
        this.innerHTML = 'Datetime is missing!'
      }

      let countDownDate = Number(this.dataset.time) * 1000

      if (window.location.href.includes('ks-')) {
        countDownDate = Date.now() + 1.728e+8
      }

      const x = setInterval(() => {
        const now = new Date().getTime()
        const distance = countDownDate - now

        const days = Math.floor(distance / (1000 * 60 * 60 * 24))
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))
        const min = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60))
        const sec = Math.floor((distance % (1000 * 60)) / 1000)

        if (days > 0) {
          this.querySelector('[data-days]').innerHTML = `${days} <em>${this.dataset.textDays}</em>`
        } else {
          this.querySelector('[data-days]')?.remove()
        }
        if (hours > 0) {
          this.querySelector('[data-hours]').innerHTML = `${hours} <em>${this.dataset.textHours}</em>`
        } else {
          this.querySelector('[data-hours]')?.remove()
        }
        this.querySelector('[data-min]').innerHTML = `${min} <em>${this.dataset.textMin}</em>`
        this.querySelector('[data-sec]').innerHTML = `${sec} <em>${this.dataset.textSec}</em>`

        this.setAttribute('data-init', '')

        if (distance < 0) {
          clearInterval(x)
          this.innerHTML = this.dataset.textExpired
        }
      }, 1000)
    }
  }
  customElements.define('ks-countdown', KsCountdown)

{%- endjavascript -%}
  
{% if show_block %}
  <div 
    id="ks-countdown-sale-{{ section.id }}"
    class="ks-countdown-sale">
    {% if section.settings.image %}
      <div 
        class="ks-media-wrapper"
        data-overlay-opacity="{{ section.settings.overlay_opacity }}"
        style="
          --overlay-color-rgb: {{ section.settings.overlay_color | color_to_rgb | remove: 'rgb(' | remove: ')' }};
          --overlay-opacity: {{ section.settings.overlay_opacity | append: '%' }};
          --overlay-blur: {{ section.settings.overlay_blur | append: 'px' }};
        ">
        <img 
          class="ks-media-media-mobile"
          src="{{ section.settings.image | image_url: width: 800 }}" 
          alt=" {{ section.settings.image.alt }}"
          width="800"
          height="{{ 800 | divided_by: section.settings.image.aspect_ratio | round }}"
          loading="lazy">
        <img 
          class="ks-media-media-desktop"
          src="{{ section.settings.image | image_url: width: 1600 }}" 
          alt=" {{ section.settings.image.alt }}"
          width="1600"
          height="{{ 1600 | divided_by: section.settings.image.aspect_ratio | round }}"
          loading="lazy">
      </div>
    {% endif %}
    
    <div class="page-width container {% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}">

      <div 
        class="ks-countdown-sale-inner"
        data-align-mobile="{% if section.blocks.first.type == 'countdown' %}column{% else %}column-reverse{% endif %}">
        {% for block in section.blocks %}
          {% if block.type == 'countdown' %}
            <div 
              class="ks-countdown-sale-countdown" {{ block.shopify_attributes }}
              data-has-text="{% if text_block %}true{% else %}false{% endif %}">
              <ks-countdown
                class="ks-countdown"
                data-time="{{ unixtime }}" 
                data-text-days="{{ block.settings.text_days }}"
                data-text-hours="{{ block.settings.text_hours }}"
                data-text-min="{{ block.settings.text_minutes }}"
                data-text-sec="{{ block.settings.text_seconds }}"
                data-text-expired="{{ block.settings.text_expired }}"
                data-animation="{% if block.settings.animation %}true{% else %}false{% endif %}"
                role="timer">
                <span data-days></span>
                <span data-hours></span>
                <span data-min></span>
                <span data-sec></span>
              </ks-countdown>
            </div>
          {% else %}
            {%- style -%}
              @media (max-width: 749px) {
                #ks-countdown-sale-{{ section.id }} .ks-countdown-sale-text {
                  text-align: {{ block.settings.text_align_mobile }}
                }
              }
              @media (min-width: 750px) {
                #ks-countdown-sale-{{ section.id }} .ks-countdown-sale-text {
                  text-align: {{ block.settings.text_align_desktop }}
                }
              }
            {%- endstyle -%}
            <div class="ks-countdown-sale-text" {{ block.shopify_attributes }}>
              {%- if block.settings.heading != blank -%}
                <h2 class="title inline-richtext {{ block.settings.heading_size }}">
                  {{ block.settings.heading }}
                </h2>
              {%- endif -%}
              {%- if block.settings.description != blank %}
                <div class="description rte">
                  {{ block.settings.description }}
                </div>
              {% endif %}
              {% if block.settings.btn_primary_text != blank or block.settings.btn_secondary_text != blank %}
                <div class="btn-wrapper">
                  {% unless block.settings.btn_primary_text == blank %}
                    <a 
                      class="button btn {{ block.settings.btn_primary_style }}"  
                      href="{{ block.settings.btn_primary_url }}">
                      {{ block.settings.btn_primary_text }}
                    </a>
                  {% endunless %}
                  {% unless block.settings.btn_secondary_text == blank %}
                    <a 
                      class="button btn {{ block.settings.btn_secondary_style }}"  
                      href="{{ block.settings.btn_secondary_url }}">
                      {{ block.settings.btn_secondary_text }}
                    </a>
                  {% endunless %}
                </div>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}  
      </div>
      
    </div>
  </div>
{% endif %}

{% schema %}
{
  "name": "KS - Countdown Sale",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "foreground_color",
      "label": "Foreground color",
      "default": "#121212"
    },
    {
      "type": "header",
      "content": "Background image"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Image",
    },
    {
      "type": "color",
      "id": "overlay_color",
      "label": "Overlay color",
      "default": "#121212"
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "label": "Opacity",
      "min": 0,
      "max": 100,
      "step": 10,
      "default": 30,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "overlay_blur",
      "label": "Blur",
      "min": 0,
      "max": 10,
      "step": 1,
      "default": 0
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "pt",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top",
      "default": 36
    },
    {
      "type": "range",
      "id": "pb",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom",
      "default": 36
    },
    {
      "type": "header",
      "content": "Get Support",
      "info": "Please use our [Support Forum](https://community.kondasoft.com) to get help from our support team. "
    },
    {
      "type": "header",
      "content": "Shopify Snippets",
      "info": "Check out our other [Shopify Snippets](https://www.kondasoft.com/collections/shopify-snippets)"
    },
    {
      "type": "header",
      "content": "Shopify Themes",
      "info": "Check out our Premium and Free [Shopify Themes](https://www.kondasoft.com/collections/shopify-themes)."
    },
    {
      "type": "paragraph",
      "content": "© 2025 KondaSoft.com"
    }
  ],
  "blocks": [
    {
      "type": "countdown",
      "name": "Countdown",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "datetime",
          "label": "Datetime",
          "default": "2026-01-01 00:00",
          "info": "Format: yyyy-mm-dd hh:mm. NOTE: The date/time is based on the timezone specified in the Shopify general settings. Also, if the timer expires the whole section will be hidden."
        },
        {
          "type": "header",
          "content": "Styling"
        },
        {
          "type": "color",
          "id": "bg_color",
          "label": "Background color"
        },
        {
          "type": "color",
          "id": "text_color",
          "label": "Text color",
          "default": "#121212"
        },
        {
          "type": "range",
          "id": "border_width",
          "label": "Border width",
          "min": 0,
          "max": 10,
          "step": 1,
          "default": 2
        },
        {
          "type": "color",
          "id": "border_color",
          "label": "Border color",
          "default": "#121212"
        },
        {
          "type": "range",
          "id": "font_size_mobile",
          "label": "Font-size mobile",
          "min": 40,
          "max": 120,
          "step": 2,
          "default": 44,
          "unit": "px"
        },
        {
          "type": "range",
          "id": "font_size_desktop",
          "label": "Font-size desktop",
          "min": 50,
          "max": 120,
          "step": 2,
          "default": 64,
          "unit": "px"
        },
        {
          "type": "checkbox",
          "id": "animation",
          "label": "Animation",
          "default": true
        },
        {
          "type": "header",
          "content": "Translation"
        },
        {
          "type": "text",
          "id": "text_days",
          "label": "Days",
          "default": "Days"
        },
        {
          "type": "text",
          "id": "text_minutes",
          "label": "Minutes",
          "default": "Minutes"
        },
        {
          "type": "text",
          "id": "text_hours",
          "label": "Hours",
          "default": "Hours"
        },
        {
          "type": "text",
          "id": "text_seconds",
          "label": "Seconds",
          "default": "Seconds"
        },
        {
          "type": "text",
          "id": "text_expired",
          "label": "Expired",
          "default": "Offer has expired!"
        }
      ]
    },
    {
      "type": "text",
      "name": "Text",
      "limit": 1,
      "settings": [
        {
          "type": "header",
          "content": "General"
        },
        {
          "type": "text_alignment",
          "id": "text_align_mobile",
          "label": "Text align - mobile",
          "default": "center"
        },
        {
          "type": "text_alignment",
          "id": "text_align_desktop",
          "label": "Text align - desktop",
          "default": "left"
        },
        {
          "type": "header",
          "content": "Text"
        },
        {
          "type": "inline_richtext",
          "id": "heading",
          "label": "Heading",
          "default": "Countdown Sale"
        },
        {
          "type": "select",
          "id": "heading_size",
          "label": "Heading size",
          "options": [
            { "value": "h0", "label": "H0" },
            { "value": "h1", "label": "H1" },
            { "value": "h2", "label": "H2" },
            { "value": "h3", "label": "H3" },
            { "value": "h4", "label": "H4" },
            { "value": "h5", "label": "H5" },
            { "value": "h6", "label": "H6" }
          ],
          "default": "h1",
        },
        {
          "type": "richtext",
          "id": "description",
          "default": "<p>Use this section to showcase your offers that require a sense of urgency.</p>",
          "info": "Leave empty to disable",
          "label": "Description"
        },
        {
          "type": "header",
          "content": "Primary button"
        },
        {
          "type": "text",
          "id": "btn_primary_text",
          "label": "Button text",
          "default": "Primary button",
          "info": "Leave empty to disable"
        },
        {
          "type": "select",
          "id": "btn_primary_style",
          "label": "Button style",
          "default": "button--primary btn-primary",
          "options": [
            { "value": "button--primary btn-primary", "label": "Primary" },
            { "value": "button--secondary btn-secondary", "label": "Secondary" }
          ]
        },
        {
          "type": "url",
          "id": "btn_primary_url",
          "label": "Button URL"
        },
        {
          "type": "header",
          "content": "Secondary button"
        },
        {
          "type": "text",
          "id": "btn_secondary_text",
          "label": "Button text",
          "default": "Secondary button",
          "info": "Leave empty to disable"
        },
        {
          "type": "select",
          "id": "btn_secondary_style",
          "label": "Button style",
          "default": "button--secondary btn-secondary",
          "options": [
            { "value": "button--primary btn-primary", "label": "Primary" },
            { "value": "button--secondary btn-secondary", "label": "Secondary" }
          ]
        },
        {
          "type": "url",
          "id": "btn_secondary_url",
          "label": "Button URL"
        },
      ]
    }
  ],
  "presets": [
    {
      "name": "KS - Countdown Sale",
      "blocks": [
        {
          "type": "countdown"
        },
        {
          "type": "text"
        }
      ]
    }
  ]
}
{% endschema %}
